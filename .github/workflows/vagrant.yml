# Build and publish Vagrant box with Packer (HCL) on GitHub-hosted runners
name: packer-build-and-publish

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      box_name:
        description: 'Full Vagrant Cloud box name (user/box). Example: myuser/mybox'
        required: false
      box_version:
        description: 'Version to publish. Example: 1.0.0'
        required: false

permissions:
  contents: read
  id-token: write

env:
  PACKER_VERSION: "1.9.3"
  HCP_CLI_VERSION: "0.1.0"
  PACKER_TEMPLATE: "packer-templage.hcl.pkr"
  PACKER_PROVIDER: "virtualbox"
  # Default box name used when no input/secret is provided
  DEFAULT_BOX_NAME: "ulrich-sun/default-box"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate and set inputs (supports defaults)
        id: vars
        run: |
          set -euo pipefail

          # Get workflow inputs (may be empty)
          BOX_NAME_INPUT="${{ github.event.inputs.box_name || '' }}"
          BOX_VERSION_INPUT="${{ github.event.inputs.box_version || '' }}"

          BOX_NAME="$BOX_NAME_INPUT"
          BOX_VERSION="$BOX_VERSION_INPUT"

          # If no box_name input, try repo secret BOX_NAME, else use DEFAULT_BOX_NAME
          if [ -z "$BOX_NAME" ]; then
            if [ -n "${{ secrets.BOX_NAME }}" ]; then
              BOX_NAME="${{ secrets.BOX_NAME }}"
            else
              BOX_NAME="${DEFAULT_BOX_NAME}"
            fi
          fi

          # If no box_version input, try repo secret BOX_VERSION, then git tag, else short sha
          if [ -z "$BOX_VERSION" ]; then
            if [ -n "${{ secrets.BOX_VERSION }}" ]; then
              BOX_VERSION="${{ secrets.BOX_VERSION }}"
            elif [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
              BOX_VERSION="${GITHUB_REF#refs/tags/}"
            else
              BOX_VERSION="auto-${GITHUB_SHA:0:7}"
            fi
          fi

          echo "Resolved box_name=$BOX_NAME"
          echo "Resolved box_version=$BOX_VERSION"

          echo "box_name=$BOX_NAME" >> $GITHUB_OUTPUT
          echo "box_version=$BOX_VERSION" >> $GITHUB_OUTPUT

      - name: Ensure $HOME/.local/bin is on PATH
        run: |
          mkdir -p "$HOME/.local/bin"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache Packer binary (by version)
        id: cache_packer
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.cache/packer/${{ env.PACKER_VERSION }}
          key: ${{ runner.os }}-packer-${{ env.PACKER_VERSION }}
          restore-keys: |
            ${{ runner.os }}-packer-

      - name: Install Packer (if cache miss)
        if: steps.cache_packer.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          PK_V=${{ env.PACKER_VERSION }}
          URL="https://releases.hashicorp.com/packer/${PK_V}/packer_${PK_V}_linux_amd64.zip"
          TMPZIP="/tmp/packer_${PK_V}.zip"
          echo "Downloading packer $PK_V from $URL"
          curl -fsSL -o "$TMPZIP" "$URL"
          unzip -o "$TMPZIP" -d "$HOME/.local/bin"
          mkdir -p "${{ github.workspace }}/.cache/packer/${PK_V}"
          mv "$HOME/.local/bin/packer" "${{ github.workspace }}/.cache/packer/${PK_V}/packer"
          ln -sf "${{ github.workspace }}/.cache/packer/${PK_V}/packer" "$HOME/.local/bin/packer"
          chmod +x "${{ github.workspace }}/.cache/packer/${PK_V}/packer"
          rm -f "$TMPZIP"

      - name: Verify Packer installed
        run: |
          packer --version

      - name: Cache HCP CLI (by version)
        id: cache_hcp
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.cache/hcp-cli/${{ env.HCP_CLI_VERSION }}
          key: ${{ runner.os }}-hcp-cli-${{ env.HCP_CLI_VERSION }}
          restore-keys: |
            ${{ runner.os }}-hcp-cli-

      - name: Install HCP CLI (if cache miss)
        if: steps.cache_hcp.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          HC_V=${{ env.HCP_CLI_VERSION }}
          URL="https://releases.hashicorp.com/hcp-cli/${HC_V}/hcp-cli_${HC_V}_linux_amd64.zip"
          TMPZIP="/tmp/hcp-cli_${HC_V}.zip"
          echo "Downloading hcp-cli $HC_V from $URL"
          curl -fsSL -o "$TMPZIP" "$URL"
          unzip -o "$TMPZIP" -d "$HOME/.local/bin"
          mkdir -p "${{ github.workspace }}/.cache/hcp-cli/${HC_V}"
          for bin in "$HOME/.local/bin/"hcp*; do
            if [ -f "$bin" ]; then
              mv "$bin" "${{ github.workspace }}/.cache/hcp-cli/${HC_V}/$(basename "$bin")"
              ln -sf "${{ github.workspace }}/.cache/hcp-cli/${HC_V}/$(basename "$bin")" "$HOME/.local/bin/$(basename "$bin")"
              chmod +x "${{ github.workspace }}/.cache/hcp-cli/${HC_V}/$(basename "$bin")"
            fi
          done
          rm -f "$TMPZIP"

      - name: Verify hcp-cli installed
        run: |
          if command -v hcp >/dev/null 2>&1; then hcp version || true; elif command -v hcp-cli >/dev/null 2>&1; then hcp-cli version || true; else echo "hcp binary not found in PATH"; fi

      - name: Acquire VAGRANT_CLOUD_TOKEN (HCP) â€” secret or OIDC exchange fallback
        id: get_token
        env:
          ACTIONS_ID_TOKEN_REQUEST_URL: ${{ env.ACTIONS_ID_TOKEN_REQUEST_URL }}
          ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${{ env.ACTIONS_ID_TOKEN_REQUEST_TOKEN }}
        run: |
          # Prefer HCP_API_TOKEN secret
          if [ -n "${{ secrets.HCP_API_TOKEN }}" ]; then
            echo "Using provided HCP_API_TOKEN secret"
            echo "vagrant_cloud_token=${{ secrets.HCP_API_TOKEN }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Fallback to OIDC exchange if configured
          if [ -z "${{ secrets.HCP_OIDC_AUDIENCE }}" ] || [ -z "${{ secrets.HCP_TOKEN_EXCHANGE_ENDPOINT }}" ]; then
            echo "ERROR: no HCP_API_TOKEN and no OIDC exchange configuration. Set HCP_API_TOKEN or configure OIDC and set HCP_OIDC_AUDIENCE + HCP_TOKEN_EXCHANGE_ENDPOINT"
            exit 1
          fi

          echo "Requesting OIDC token for audience ${{ secrets.HCP_OIDC_AUDIENCE }}"
          OIDC_URL="${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${{ secrets.HCP_OIDC_AUDIENCE }}"
          OIDC_RESP=$(curl -sSX POST -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" "${OIDC_URL}")
          ID_TOKEN=$(echo "$OIDC_RESP" | jq -r .value)
          if [ -z "$ID_TOKEN" ] || [ "$ID_TOKEN" = "null" ]; then
            echo "Failed to obtain OIDC token. Response: $OIDC_RESP"
            exit 1
          fi

          EXCHANGE_ENDPOINT="${{ secrets.HCP_TOKEN_EXCHANGE_ENDPOINT }}"
          RESP=$(curl -sSX POST "${EXCHANGE_ENDPOINT}" -H "Content-Type: application/json" -d "{\"subject_token\":\"$ID_TOKEN\",\"subject_token_type\":\"urn:ietf:params:oauth:token-type:jwt\"}")
          HCP_TOKEN=$(echo "$RESP" | jq -r '.access_token // .token // .value')
          if [ -z "$HCP_TOKEN" ] || [ "$HCP_TOKEN" = "null" ]; then
            echo "Failed to exchange OIDC token for HCP token. Response: $RESP"
            exit 1
          fi
          echo "vagrant_cloud_token=$HCP_TOKEN" >> $GITHUB_OUTPUT

      - name: Export VAGRANT_CLOUD_TOKEN
        run: |
          echo "VAGRANT_CLOUD_TOKEN=${{ steps.get_token.outputs.vagrant_cloud_token }}" >> $GITHUB_ENV

      - name: Validate Packer template
        run: |
          if [ ! -f "${{ env.PACKER_TEMPLATE }}" ]; then
            echo "ERROR: Packer template '${{ env.PACKER_TEMPLATE }}' not found in repo root."
            ls -la
            exit 1
          fi
          packer validate "${{ env.PACKER_TEMPLATE }}"

      - name: Build box with Packer (HCL)
        id: packer_build
        run: |
          set -euo pipefail
          BOX_NAME="${{ steps.vars.outputs.box_name }}"
          BOX_VERSION="${{ steps.vars.outputs.box_version }}"
          echo "Building box with packer template '${{ env.PACKER_TEMPLATE }}' (box=${BOX_NAME} version=${BOX_VERSION})"
          packer build \
            -var "box_name=${BOX_NAME}" \
            -var "box_version=${BOX_VERSION}" \
            "${{ env.PACKER_TEMPLATE }}"

          BOX_FILE=$(find . -type f -name "*.box" -print -quit || true)
          if [ -z "$BOX_FILE" ]; then
            echo "ERROR: No .box file found after packer build"
            exit 1
          fi
          echo "box_file=$BOX_FILE" >> $GITHUB_OUTPUT
          echo "Produced: $BOX_FILE"

      - name: Publish box to Vagrant Cloud (API fallback)
        id: publish
        env:
          VAGRANT_CLOUD_TOKEN: ${{ env.VAGRANT_CLOUD_TOKEN }}
        run: |
          set -euo pipefail
          BOX_NAME="${{ steps.vars.outputs.box_name }}"
          BOX_VERSION="${{ steps.vars.outputs.box_version }}"
          BOX_FILE="${{ steps.packer_build.outputs.box_file }}"
          TOKEN="${{ steps.get_token.outputs.vagrant_cloud_token }}"
          PROVIDER="${{ secrets.PACKER_PROVIDER || env.PACKER_PROVIDER }}"

          if [ -z "$BOX_FILE" ]; then
            echo "ERROR: box file path missing"
            exit 1
          fi

          echo "Publishing $BOX_FILE to Vagrant Cloud: $BOX_NAME version $BOX_VERSION provider $PROVIDER"

          API_BASE="https://app.vagrantup.com/api/v1"
          USER=$(echo "$BOX_NAME" | cut -d'/' -f1)
          BOX=$(echo "$BOX_NAME" | cut -d'/' -f2)

          curl -fsSX POST "${API_BASE}/boxes/${USER}/${BOX}/versions" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"version\": {\"version\": \"${BOX_VERSION}\"}}" || true

          curl -fsSX POST "${API_BASE}/boxes/${USER}/${BOX}/versions/${BOX_VERSION}/providers" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"provider\": {\"name\": \"${PROVIDER}\"}}" || true

          UPLOAD_CREATE_RESP=$(curl -fsSX POST "${API_BASE}/boxes/${USER}/${BOX}/versions/${BOX_VERSION}/providers/${PROVIDER}/uploads" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{}")
          UPLOAD_URL=$(echo "$UPLOAD_CREATE_RESP" | jq -r .upload_url)
          if [ -z "$UPLOAD_URL" ] || [ "$UPLOAD_URL" = "null" ]; then
            echo "Failed to get upload URL:"
            echo "$UPLOAD_CREATE_RESP" | jq .
            exit 1
          fi

          echo "Uploading box to upload_url..."
          curl -fsSX PUT "$UPLOAD_URL" --upload-file "$BOX_FILE" -H "Content-Type: application/octet-stream"
          echo "Upload complete"

          curl -fsSX PUT "${API_BASE}/boxes/${USER}/${BOX}/versions/${BOX_VERSION}/providers/${PROVIDER}/uploads/complete" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{}"

          echo "Box published to Vagrant Cloud (API)."

      - name: Cleanup artifacts
        if: always()
        run: |
          set -euo pipefail
          find . -type f -name "*.box" -print -delete || true
          rm -rf .packer.d || true
          echo "Cleanup done."
